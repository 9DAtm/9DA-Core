{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/9DAtm/9DA/schemas/compliance-report.schema.json",
  "title": "9DA Compliance Report Schema",
  "description": "Machine-verifiable compliance artifact representing the audited state of a 9DA system, repository, or release.",
  "type": "object",
  "additionalProperties": false,

  "required": [
    "report_identity",
    "subject",
    "governing_references",
    "compliance_evaluations",
    "violations",
    "evidence",
    "certification_status",
    "audit_metadata"
  ],

  "properties": {
    "report_identity": {
      "type": "object",
      "required": ["report_id", "report_type", "generated_at"],
      "additionalProperties": false,
      "properties": {
        "report_id": {
          "type": "string",
          "pattern": "^CR-[0-9]{4}-[A-Z0-9]+$"
        },
        "report_type": {
          "type": "string",
          "enum": [
            "Repository-Compliance",
            "Release-Compliance",
            "Ecosystem-Compliance"
          ]
        },
        "generated_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    },

    "subject": {
      "type": "object",
      "required": ["name", "version", "scope"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 3
        },
        "version": {
          "type": "string",
          "minLength": 1
        },
        "scope": {
          "type": "string",
          "enum": ["Single-Repository", "Multi-Repository", "Full-Ecosystem"]
        }
      }
    },

    "governing_references": {
      "type": "object",
      "required": [
        "architecture",
        "dependency_matrix",
        "ethics",
        "release_process",
        "metrics"
      ],
      "additionalProperties": false,
      "properties": {
        "architecture": {
          "type": "string",
          "const": "9DA-Core/ARCHITECTURE.md"
        },
        "dependency_matrix": {
          "type": "string",
          "const": "9DA-Core/DEPENDENCY-MATRIX.md"
        },
        "ethics": {
          "type": "string",
          "const": "9DA-Core/ETHICS.md"
        },
        "release_process": {
          "type": "string",
          "const": "9DA-Core/RELEASE-PROCESS.md"
        },
        "metrics": {
          "type": "string",
          "const": "9DA-Core/METRICS.md"
        }
      }
    },

    "compliance_evaluations": {
      "type": "object",
      "required": [
        "architecture",
        "dependencies",
        "adrs",
        "ethics",
        "integration_tests",
        "metrics"
      ],
      "additionalProperties": false,
      "properties": {
        "architecture": {
          "type": "object",
          "required": ["validated", "violations"],
          "properties": {
            "validated": { "type": "boolean" },
            "violations": { "type": "integer", "minimum": 0 }
          }
        },
        "dependencies": {
          "type": "object",
          "required": ["validated", "cycles_detected"],
          "properties": {
            "validated": { "type": "boolean" },
            "cycles_detected": { "type": "integer", "minimum": 0 }
          }
        },
        "adrs": {
          "type": "object",
          "required": ["coverage_complete", "unaccepted_count"],
          "properties": {
            "coverage_complete": { "type": "boolean" },
            "unaccepted_count": { "type": "integer", "minimum": 0 }
          }
        },
        "ethics": {
          "type": "object",
          "required": ["validated", "violations"],
          "properties": {
            "validated": { "type": "boolean" },
            "violations": { "type": "integer", "minimum": 0 }
          }
        },
        "integration_tests": {
          "type": "object",
          "required": ["pass_rate"],
          "properties": {
            "pass_rate": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            }
          }
        },
        "metrics": {
          "type": "object",
          "required": ["thresholds_met"],
          "properties": {
            "thresholds_met": { "type": "boolean" }
          }
        }
      }
    },

    "violations": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["category", "severity", "description"],
        "additionalProperties": false,
        "properties": {
          "category": {
            "type": "string",
            "enum": [
              "Architecture",
              "Dependency",
              "ADR",
              "Ethics",
              "Integration",
              "Metrics"
            ]
          },
          "severity": {
            "type": "string",
            "enum": ["Low", "Medium", "High", "Critical"]
          },
          "description": {
            "type": "string",
            "minLength": 20
          },
          "reference": {
            "type": "string",
            "minLength": 5
          }
        }
      }
    },

    "evidence": {
      "type": "object",
      "required": ["ci_runs", "artifacts"],
      "additionalProperties": false,
      "properties": {
        "ci_runs": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "format": "uri"
          }
        },
        "artifacts": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "uri"
          }
        }
      }
    },

    "certification_status": {
      "type": "object",
      "required": ["compliant", "certification_level"],
      "additionalProperties": false,
      "properties": {
        "compliant": { "type": "boolean" },
        "certification_level": {
          "type": "string",
          "enum": [
            "Not-Certified",
            "9DA-Compliant",
            "9DA-Certified"
          ]
        }
      }
    },

    "audit_metadata": {
      "type": "object",
      "required": [
        "audited_by",
        "auditor_role",
        "audit_date"
      ],
      "additionalProperties": false,
      "properties": {
        "audited_by": {
          "type": "string",
          "minLength": 3
        },
        "auditor_role": {
          "type": "string",
          "enum": ["CI-System", "Release-Auditor", "9DA-Core-Maintainer"]
        },
        "audit_date": {
          "type": "string",
          "format": "date"
        }
      }
    }
  },

  "allOf": [
    {
      "if": {
        "properties": {
          "certification_status": {
            "properties": {
              "certification_level": {
                "const": "9DA-Certified"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "certification_status": {
            "properties": {
              "compliant": {
                "const": true
              }
            }
          },
          "violations": {
            "maxItems": 0
          }
        }
      }
    }
  ]
}
