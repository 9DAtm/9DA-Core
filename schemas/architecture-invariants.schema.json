{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/9DAtm/9DA/schemas/architecture-invariants.schema.json",
  "title": "9DA Architecture Invariants Enforcement Schema",
  "type": "object",
  "additionalProperties": false,

  "required": [
    "governing_architecture_reference",
    "repository_identity",
    "declared_layer",
    "allowed_artifact_types",
    "forbidden_artifact_types",
    "dependency_constraints",
    "cross_layer_rules",
    "enforcement_attestation"
  ],

  "properties": {
    "governing_architecture_reference": {
      "type": "object",
      "required": ["document", "version"],
      "additionalProperties": false,
      "properties": {
        "document": {
          "type": "string",
          "const": "9DA-Core/ARCHITECTURE.md"
        },
        "version": {
          "type": "string",
          "minLength": 1
        }
      }
    },

    "repository_identity": {
      "type": "object",
      "required": ["name", "layer", "lifecycle_status"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "enum": [
            "9DA-Core",
            "9DA-Specifications",
            "9DA-Design-Documents",
            "9DA-SDK",
            "9DA-Reference-Implementation",
            "9DA-Tools",
            "9DA-Examples",
            ".github"
          ]
        },
        "layer": {
          "type": "string",
          "enum": ["Conceptual", "Logical", "Physical", "Meta"]
        },
        "lifecycle_status": {
          "type": "string",
          "enum": ["Stable", "Evolving", "Experimental", "Deprecated"]
        }
      }
    },

    "declared_layer": {
      "type": "string",
      "enum": ["Conceptual", "Logical", "Physical", "Meta"]
    },

    "allowed_artifact_types": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "enum": [
          "Markdown",
          "Specification",
          "ADR",
          "RFC",
          "Diagram",
          "Schema",
          "SourceCode",
          "Executable",
          "Script",
          "Configuration"
        ]
      }
    },

    "forbidden_artifact_types": {
      "type": "array",
      "uniqueItems": true,
      "items": {
        "type": "string",
        "enum": [
          "Markdown",
          "Specification",
          "ADR",
          "RFC",
          "Diagram",
          "Schema",
          "SourceCode",
          "Executable",
          "Script",
          "Configuration"
        ]
      }
    },

    "dependency_constraints": {
      "type": "object",
      "required": [
        "allowed_dependency_layers",
        "forbidden_dependency_layers",
        "core_dependency_rule"
      ],
      "additionalProperties": false,
      "properties": {
        "allowed_dependency_layers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["Conceptual", "Logical", "Physical", "Meta"]
          }
        },
        "forbidden_dependency_layers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["Conceptual", "Logical", "Physical", "Meta"]
          }
        },
        "core_dependency_rule": {
          "type": "string",
          "enum": ["CoreIsDependencySilent"]
        }
      }
    },

    "cross_layer_rules": {
      "type": "object",
      "required": [
        "reverse_dependency_prohibited",
        "execution_in_conceptual_prohibited",
        "execution_in_logical_prohibited"
      ],
      "additionalProperties": false,
      "properties": {
        "reverse_dependency_prohibited": {
          "type": "boolean",
          "const": true
        },
        "execution_in_conceptual_prohibited": {
          "type": "boolean",
          "const": true
        },
        "execution_in_logical_prohibited": {
          "type": "boolean",
          "const": true
        }
      }
    },

    "enforcement_attestation": {
      "type": "object",
      "required": [
        "ci_enforced",
        "validator_used",
        "attestation_date"
      ],
      "additionalProperties": false,
      "properties": {
        "ci_enforced": {
          "type": "boolean",
          "const": true
        },
        "validator_used": {
          "type": "string",
          "minLength": 3
        },
        "attestation_date": {
          "type": "string",
          "format": "date"
        }
      }
    }
  },

  "allOf": [
    {
      "if": {
        "properties": {
          "declared_layer": {
            "const": "Conceptual"
          }
        }
      },
      "then": {
        "properties": {
          "repository_identity": {
            "properties": {
              "layer": {
                "const": "Conceptual"
              }
            }
          },
          "forbidden_artifact_types": {
            "contains": {
              "enum": ["SourceCode", "Executable", "Script"]
            },
            "minContains": 3
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "declared_layer": {
            "const": "Logical"
          }
        }
      },
      "then": {
        "properties": {
          "repository_identity": {
            "properties": {
              "layer": {
                "const": "Logical"
              }
            }
          },
          "forbidden_artifact_types": {
            "contains": {
              "const": "Executable"
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "declared_layer": {
            "const": "Physical"
          }
        }
      },
      "then": {
        "properties": {
          "repository_identity": {
            "properties": {
              "layer": {
                "const": "Physical"
              }
            }
          },
          "dependency_constraints": {
            "properties": {
              "forbidden_dependency_layers": {
                "contains": {
                  "enum": ["Conceptual", "Logical"]
                },
                "minContains": 2
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "declared_layer": {
            "const": "Meta"
          }
        }
      },
      "then": {
        "properties": {
          "repository_identity": {
            "properties": {
              "layer": {
                "const": "Meta"
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "repository_identity": {
            "properties": {
              "name": {
                "const": "9DA-Core"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "dependency_constraints": {
            "properties": {
              "allowed_dependency_layers": {
                "maxItems": 0
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "repository_identity": {
            "properties": {
              "lifecycle_status": {
                "const": "Deprecated"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "enforcement_attestation": {
            "required": ["ci_enforced", "validator_used", "attestation_date"]
          }
        }
      }
    }
  ]
}